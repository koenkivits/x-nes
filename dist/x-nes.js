!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){exports.readFile=function(filename,callback){var xhr=new XMLHttpRequest;xhr.open("GET",filename),xhr.responseType="arraybuffer",xhr.onload=function(){callback(xhr.response)},xhr.onerror=function(e){throw e},xhr.send(null)}},{}],2:[function(require,module){module.exports={input:[{type:"standard",input:"keyboard",config:{z:"a",x:"b",shift:"select","return":"start",up:"up",down:"down",left:"left",right:"right"}}]}},{}],3:[function(require,module){function System(el){this.config=config,this.frameEnded=!1,this.tickAPU=!1,this.controllers=new Controllers,this.input=new Input(this),this.output=new Output,el&&this.output.video.setElement(el),this.interval=null,this.running=!1,this.paused=!0,this.cartridge=null,this.cpu=null,this.apu=null,this.ppu=null,this.memory=null,Object.preventExtensions(this)}var CPU=require("./system/cpu"),APU=require("./system/apu"),PPU=require("./system/ppu"),Cartridge=require("./system/cartridge"),Controllers=require("./system/controllers"),Output=require("./system/output"),Memory=require("./system/memory"),utils=require("./utils"),Input=require("./system/input"),config=require("./config.json");System.prototype={load:function(filename,autorun){var self=this;utils.readFile(filename,function(data){self.initCartridge(data),"function"==typeof autorun?autorun():autorun===!0&&self.run()})},run:function(){if(!this.interval){var self=this;this.interval=setInterval(function(){self.paused||self.runFrame()},1e3/60),this.output.video.run(),this.running=!0,this.paused=!1}},runFrame:function(){for(var cpu=this.cpu,ppu=this.ppu,apu=this.apu;!ppu.frameEnded;)cpu.tick(),ppu.tick(),ppu.tick(),ppu.tick(),this.tickAPU&&apu.tick(),this.tickAPU=!this.tickAPU;ppu.frameEnded=!1},simulate:function(milliseconds){var i,frames=milliseconds/1e3*60;for(i=0;frames>i;i++)this.runFrame()},play:function(){this.paused=!1,this.running||this.run()},pause:function(){this.paused=!0},toggle:function(){return this.paused?this.play():this.pause(),this.paused},initCartridge:function(data){this.cartridge=new Cartridge(data,this),this.initCore(),this.reset()},loadCartridge:function(cartridge){this.memory.loadCartridge(cartridge),this.ppu.memory.loadCartridge(cartridge)},initCore:function(){this.cpu=new CPU(this),this.apu=new APU(this),this.ppu=new PPU(this),this.memory=new Memory(this),this.loadCartridge(this.cartridge)},reset:function(){this.cpu.reset(),this.apu.reset()}},module.exports=System},{"./config.json":2,"./system/apu":6,"./system/cartridge":10,"./system/controllers":11,"./system/cpu":13,"./system/input":14,"./system/memory":23,"./system/output":25,"./system/ppu":31,"./utils":1}],4:[function(require,module){"use strict";function Channel(){this.enabled=!1,this.lengthCounter=0,this.lengthCounterHalt=!1,this.sample=0,this.volume=0,this.masterVolume=0,this.envelopeStart=!0,this.envelopeLoop=!1,this.envelopeCounter=0,this.envelopeDividerPeriod=0,this.envelopeDividerCount=0,this.envelopeDisabled=!1}Channel.prototype={toggle:function(flag){flag?this.enable():this.disable()},disable:function(){this.enabled=!1,this.lengthCounter=0},enable:function(){this.enabled=!0},doLengthCounter:function(){this.lengthCounter&&!this.lengthCounterHalt&&this.lengthCounter--},setLengthCounter:function(value){this.enabled&&(this.lengthCounter=lengthCounterLookup[value])},doEnvelope:function(){this.envelopeStart?(this.envelopeStart=!1,this.envelopeCounter=15,this.envelopeDividerCount=this.envelopeDividerPeriod):this.envelopeDividerCount?(this.envelopeDividerCount-=1,0===this.envelopeDividerCount&&(0===this.envelopeCounter&&this.envelopeLoop?this.envelopeCounter=15:this.envelopeCounter&&(this.envelopeCounter-=1),this.envelopeDividerCount=this.envelopeDividerPeriod)):this.envelopeCounter=0,this.masterVolume=this.envelopeDisabled?this.volume:this.envelopeCounter},setEnvelope:function(value){this.volume=15&value,this.lengthCounterHalt=this.envelopeLoop=!!(32&value),this.envelopeDisabled=!!(16&value),this.envelopeDividerPeriod=this.volume+1,this.envelopeStart=!0}};var lengthCounterLookup=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30];module.exports=Channel},{}],5:[function(require,module){"use strict";function DMC(apu){this.apu=apu,this.timerMax=periodLookup[0],this.timer=this.period,this.silence=!1,this.output=0,this.sampleAddress=0,this.sampleCurrentAddress=0,this.sampleLength=0,this.sampleBytesLeft=0,this.sampleBuffer=0,this.loop=!1,this.interrupt=!1,this.bitsLeft=8,this.shifter=0,this.irqEnabled=!1,Channel.call(this),Object.preventExtensions(this)}var Channel=require("./channel");DMC.prototype=new Channel,DMC.prototype.writeRegister=function(index,value){switch(index){case 0:this.irqEnabled=!!(128&value),this.irqEnabled||(this.interrupt=!1),this.loop=!!(64&value),this.timerMax=this.timer=periodLookup[15&value]>>>1;break;case 1:this.output=127&value;break;case 2:this.sampleAddress=this.sampleCurrentAddress=49152|value<<6;break;case 3:this.sampleLength=this.sampleBytesLeft=value&&value<<4|1}},DMC.prototype.doTimer=function(){this.timerMax&&(this.timer--,this.timer<=0&&(this.silence?this.sample=0:(this.output=1&this.shifter?Math.min(this.output+2,127):Math.max(this.output-2,0),this.sample=this.output),this.shifter>>>=1,this.bitsLeft--,this.bitsLeft||(this.bitsLeft=8,this.silence=!this.sampleBytesLeft,this.silence||this.readSample()),this.timer+=this.timerMax)),this.irqEnabled&&this.interrupt&&this.apu.system.cpu.requestIRQ()},DMC.prototype.readSample=function(){this.shifter=this.sampleBuffer,this.sampleBuffer=this.apu.system.memory.read(this.sampleCurrentAddress),this.sampleCurrentAddress++,65535===this.sampleCurrentAddress&&(this.sampleCurrentAddress=32768),this.sampleBytesLeft--,this.sampleBytesLeft||(this.sampleCurrentAddress=this.sampleAddress,this.loop?this.sampleBytesLeft=this.sampleLength:this.interrupt=this.irqEnabled)};var periodLookup=[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54];module.exports=DMC},{"./channel":4}],6:[function(require,module){"use strict";function APU(system){this.system=system,this.output=system.output.audio,this.sampleCounter=0,this.sampleCounterMax=894886.5/this.output.sampleRate,this.frameCounterMode=0,this.frameCounterInterrupt=!1,this.frameCount=0,this.cycles=0,this.pulse1=new Pulse,this.pulse2=new Pulse,this.triangle=new Triangle,this.noise=new Noise,this.dmc=new DMC(this),Object.preventExtensions(this)}var Pulse=require("./pulse"),Triangle=require("./triangle"),Noise=require("./noise"),DMC=require("./dmc");APU.prototype={reset:function(){this.writeStatus(0)},readRegister:function(address){return 21===address?this.readStatus():0},readStatus:function(){return!!this.pulse1.lengthCounter<<0|!!this.pulse2.lengthCounter<<1|!!this.triangle.lengthCounter<<2|!!this.noise.lengthCounter<<3|!!this.dmc.sampleBytesLeft<<4},writeRegister:function(address,value){4>address?this.pulse1.writeRegister(address,value):8>address?this.pulse2.writeRegister(address-4,value):12>address?this.triangle.writeRegister(address-8,value):16>address?this.noise.writeRegister(address-12,value):20>address?this.dmc.writeRegister(address-16,value):21===address?this.writeStatus(value):23===address&&(this.frameCounterMode=+!!(128&value),this.frameCounterInterrupt=!(64&value),this.cycles=0,this.frameCounterMode&&(this.doQuarterFrame(),this.doHalfFrame()))},writeStatus:function(value){this.pulse1.toggle(1&value),this.pulse2.toggle(2&value),this.triangle.toggle(4&value),this.noise.toggle(8&value)},tick:function(){switch(this.frameCounterMode){case 0:this.tick0();break;default:this.tick1()}this.cycles+=1,this.updateSample()},tick0:function(){switch(this.cycles){case 3728:case 7457:case 11186:case 14915:this.doQuarterFrame()}switch(this.cycles){case 7457:case 14915:this.doHalfFrame()}this.cycles>=14915&&(this.cycles=0,this.frameCounterInterrupt&&this.system.cpu.requestIRQ())},tick1:function(){switch(this.cycles){case 3729:case 7457:case 11186:case 18641:this.doQuarterFrame()}switch(this.cycles){case 7457:case 18641:this.doHalfFrame()}this.cycles>=18641&&(this.cycles=0)},doQuarterFrame:function(){this.pulse1.doEnvelope(),this.pulse2.doEnvelope(),this.noise.doEnvelope(),this.triangle.doLinearCounter()},doHalfFrame:function(){this.pulse1.doSweep(),this.pulse1.doLengthCounter(),this.pulse2.doSweep(),this.pulse2.doLengthCounter(),this.triangle.doLengthCounter(),this.noise.doLengthCounter()},updateSample:function(){var tndOut=0,pulseOut=0;this.pulse1.doTimer(),this.pulse2.doTimer(),this.triangle.doTimer(),this.noise.doTimer(),this.dmc.doTimer(),this.output.enabled&&(this.sampleCounter>=this.sampleCounterMax&&(pulseOut=pulseTable[this.pulse1.sample+this.pulse2.sample],tndOut=tndTable[3*this.triangle.sample+2*this.noise.sample+this.dmc.sample],this.output.writeSample(pulseOut+tndOut),this.sampleCounter-=this.sampleCounterMax),this.sampleCounter+=1)}};var i=0,pulseTable=new Float32Array(31);for(i=0;31>i;i++)pulseTable[i]=95.52/(8128/i+100);var tndTable=new Float32Array(203);for(i=0;203>i;i++)tndTable[i]=163.67/(24329/i+100);module.exports=APU},{"./dmc":5,"./noise":7,"./pulse":8,"./triangle":9}],7:[function(require,module){"use strict";function Noise(){this.shift=1,this.mode=0,this.timerMax=periodLookup[0],this.timer=this.period,this.index=3,Channel.call(this),Object.preventExtensions(this)}var Channel=require("./channel");Noise.prototype=new Channel,Noise.prototype.doTimer=function(){var feedback=0,otherBit=0;this.timerMax&&(this.timer?this.timer--:(otherBit=this.mode?(64&this.shift)>>6:(2&this.shift)>>1,feedback=1&(this.shift^otherBit),this.shift>>>=1,this.shift|=feedback<<14,this.sample=!this.lengthCounter||1&this.shift?0:this.masterVolume,this.timer+=this.timerMax))},Noise.prototype.writeRegister=function(index,value){switch(index){case 0:this.setEnvelope(value);break;case 1:break;case 2:this.mode=(128&value)>>>7,this.timerMax=this.timer=periodLookup[15&value];break;case 3:this.setLengthCounter(value>>>3),this.envelopeStart=!0}};var periodLookup=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068];module.exports=Noise},{"./channel":4}],8:[function(require,module){"use strict";function Pulse(){this.timerMax=0,this.timer=0,this.duty=0,this.sweepStart=!0,this.sweepEnabled=!1,this.sweepDividerPeriod=0,this.sweepDividerCount=0,this.sweepNegate=!1,this.sweepShiftCount=0,this.pulseCounter=0,this.silence=!1,Channel.call(this),Object.preventExtensions(this)}var Channel=require("./channel");Pulse.prototype=new Channel,Pulse.prototype.doSweep=function(){var adjustPulse=!this.sweepDividerCount,timerDelta=0,targetTimer=0;this.sweepStart&&(this.sweepDividerCount=this.sweepDividerPeriod,this.sweepStart=!1),adjustPulse?(this.sweepShiftCount&&(timerDelta=this.timerMax>>>this.sweepShiftCount),this.sweepNegate&&(timerDelta=-timerDelta),targetTimer=this.timerMax+timerDelta,this.timerMax>=8&&this.timerMax<=2047?(this.sweepEnabled&&(this.timerMax=targetTimer),this.silence=!1):this.silence=!0,this.sweepDividerCount=this.sweepDividerPeriod):this.sweepDividerCount&&this.sweepDividerCount--},Pulse.prototype.doTimer=function(){!this.silence&&this.lengthCounter&&this.timerMax?this.timer?this.timer--:(this.timer+=this.timerMax,this.pulseCounter=this.pulseCounter+1&7,this.sample=pulseDutyLookup[(this.duty<<3)+this.pulseCounter]*this.masterVolume):this.sample=0},Pulse.prototype.writeRegister=function(index,value){switch(index){case 0:this.duty=(192&value)>>6,this.setEnvelope(value);break;case 1:this.sweepStart=!0,this.sweepEnabled=!!(128&value),this.sweepDividerPeriod=((112&value)>>4)+1,this.sweepNegate=!!(8&value),this.sweepShiftCount=7&value;break;case 2:this.timer=this.timerMax=-256&this.timerMax|value;break;case 3:this.timer=this.timerMax=-65281&this.timerMax|(7&value)<<8,this.setLengthCounter(value>>>3),this.envelopeStart=!0,this.pulseCounter=0}this.silence=this.timerMax<8};var pulseDutyLookup=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1];module.exports=Pulse},{"./channel":4}],9:[function(require,module){"use strict";function Triangle(){this.linearCounter=0,this.linearCounterMax=0,this.linearCounterControl=!1,this.linearCounterStart=!1,this.timerMax=0,this.timer=0,this.sequenceCounter=0,Channel.call(this),Object.preventExtensions(this)}var Channel=require("./channel");Triangle.prototype=new Channel,Triangle.prototype.doLinearCounter=function(){this.linearCounterStart?this.linearCounter=this.linearCounterMax:this.linearCounter&&this.linearCounter--,this.linearCounterControl||(this.linearCounterStart=!1)},Triangle.prototype.doTimer=function(){this.timerMax&&(this.timer-=2,this.timer<=0&&(this.timer+=this.timerMax,this.sequenceCounter=this.sequenceCounter+1&31,this.sample=sequence[this.sequenceCounter])),this.lengthCounter&&this.linearCounter||(this.sample=0)},Triangle.prototype.writeRegister=function(index,value){switch(index){case 0:this.linearCounterMax=-129&value,this.lengthCounterHalt=this.linearCounterControl=!!(128&value);break;case 1:break;case 2:this.timer=this.timerMax=-256&this.timerMax|value;break;case 3:this.timer=this.timerMax=-65281&this.timerMax|(7&value)<<8,this.setLengthCounter(value>>>3),this.linearCounterStart=!0}};var sequence=[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];module.exports=Triangle},{"./channel":4}],10:[function(require,module){"use strict";function Cartridge(data,system){this.system=system,this.raw=data,this.data=new Uint8Array(data,16,data.byteLength-16),this.header=new Uint8Array(data,0,16),this.validate(),this.initHeader(),this.initData(),Object.preventExtensions(this)}var mappers=require("./mappers"),HORIZONTAL=0,VERTICAL=1,FOUR_SCREEN=2,SINGLE_SCREEN_LOWER=3,SINGLE_SCREEN_UPPER=4;Cartridge.prototype={validate:function(){if(78!==this.header[0]||69!==this.header[1]||83!==this.header[2]||26!==this.header[3])throw new Error("Invalid ROM!");if(14&this.header[7])throw new Error("Bit 1-3 of byte 7 in ROM header must all be zeroes!");if(254&this.header[9])throw new Error("Bit 1-7 of byte 9 in header must all be zeroes!");var i;for(i=10;15>=i;i++)if(this.header[i])throw new Error("Byte "+i+" in ROM header must be zero.");if(4&this.header[6])throw new Error("Trained ROMs are not supported")},initHeader:function(){var flags6=this.header[6];this.mirroring=1&flags6?VERTICAL:HORIZONTAL,this.battery=2&flags6,this.trainer=4&flags6,this.mirroring=8&flags6?FOUR_SCREEN:this.mirroring;var flags7=this.header[7];this.vs=1&flags7,this.mapper=(240&flags6)>>4|240&flags7,this.pal=1&this.header[9]},initData:function(){this.prgBanks=this.header[4],this.chrBanks=this.header[5],this.ramBanks=this.header[8]||1,this.prgSize=16*this.prgBanks*1024,this.chrSize=8*this.chrBanks*1024,this.ramSize=8*this.ramBanks*1024,this.prgData=this.data.subarray(0,this.prgSize),this.chrData=this.chrBanks?this.data.subarray(this.prgSize,this.prgSize+this.chrSize):new Uint8Array(8192),this.ramData=new Uint8Array(this.ramSize),this.initMapper()},initMapper:function(){this.prgRead=new Uint8Array(32768),this.prgRead.set(this.prgData.subarray(0,8192)),this.chrRead=new Uint8Array(8192),this.chrRead.set(this.chrData.subarray(0,8192)),mappers.init(this)},writeRegister:function(){},readPRG:function(address){return 32768&address?this.prgRead[32767&address]:address>=24576?this.ramData[address-24576]:0},writePRG:function(address,value){32768&address?this.writeRegister(address,value):address>=24576&&(this.ramData[address-24576]=value)},loadPRGBank:function(address,bank,size){var offset=bank*size,bankData=this.prgData.subarray(offset,offset+size);this.prgRead.set(bankData,address-32768)},readCHR:function(address){return this.chrRead[address]},writeCHR:function(address,value){return this.chrBanks||(this.chrRead[address]=value),value},readTile:function(baseTable,tileIndex,y){var tileAddress=(tileIndex<<4)+baseTable+y;return this.readCHR(tileAddress)<<8|this.readCHR(tileAddress+8)},loadCHRBank:function(address,bank,size){var offset=bank*size,bankData=this.chrData.subarray(offset,offset+size);this.chrRead.set(bankData,address)},getNameTableAddress:function(address){switch(this.mirroring){case HORIZONTAL:address>=1024&&(address-=1024),address>=2048&&(address-=1024);break;case VERTICAL:address&=2047;break;case FOUR_SCREEN:throw new Error("TODO, four screen mirroring");case SINGLE_SCREEN_LOWER:case SINGLE_SCREEN_UPPER:address&=1023,4===this.mirroring&&(address+=1024)}return address},readNameTable:function(address){return this.system.ppu.ram[this.getNameTableAddress(address)]},writeNameTable:function(address,value){this.system.ppu.ram[this.getNameTableAddress(address)]=value}},module.exports=Cartridge},{"./mappers":17}],11:[function(require,module){function Controllers(system){this.system=system,this.controller0=new NoController,this.controller1=new NoController,this.controllers=new Array(CONTROLLER_COUNT),this.strobe=0}function NoController(){}var CONTROLLER_COUNT=2;Controllers.prototype={get:function(index){return index?this.controller1:this.controller0},connect:function(index,controller){index?this.controller1=controller:this.controller0=controller},read:function(index){return this.get(index).read()},write:function(value){var strobe=1&value;this.controller0.setStrobe(strobe),this.controller1.setStrobe(strobe)}},NoController.prototype={read:function(){return 0},setStrobe:function(){}},module.exports=Controllers},{}],12:[function(require,module){"use strict";function StandardController(){this.data=0,this.mask=0,this.strobe=0,Object.preventExtensions(this)}function getBitMask(button){return buttonMap[button.toLowerCase()]||0}StandardController.prototype={press:function(button){this._press(getBitMask(button))},depress:function(button){this._depress(getBitMask(button))},_press:function(bitmask){3&bitmask?this._depress(3):12&bitmask&&this._depress(12),this.data|=bitmask},_depress:function(bitmask){this.data&=~bitmask},read:function(){if(!this.mask)return 1;var result=this.data&this.mask;return this.strobe||(this.mask>>=1),+!!result},setStrobe:function(value){value&&(this.mask=128),this.strobe=value}};var buttonMap={a:128,b:64,select:32,start:16,up:8,down:4,left:2,right:1};module.exports=StandardController},{}],13:[function(require,module){function CPU(system){"use strict";function reset(){interrupt(VECTOR_RESET)}function requestNMI(){nmiRequested=!0}function requestIRQ(){irqRequested=!0}function doNMI(){interrupt(VECTOR_NMI),nmiRequested=!1}function doIRQ(){interrupt(VECTOR_IRQ),irqRequested=!1}function interrupt(vector){push((PC&HIGH)>>8),push(PC&LOW),setP(),push(P),flagI=1,PC=peekWord(vector),burn(7)}function burn(cycles){cyclesBurnt+=cycles}function tick(){cyclesBurnt-=1,cyclesBurnt>0||(cyclesBurnt=0,setP(),irqRequested&&!flagI&&doIRQ(),op=peek(PC),execute(op),nmiRequested&&doNMI(),delayInterrupt=!1)}function execute(op){switch(writeToA=0,address=983040,debugPC=PC,op){case 62:absoluteIndexedX(),ROL(),burn(7);break;case 61:absoluteIndexedX(),AND(),burn(4);break;case 133:zeroPage(),STA(),burn(3);break;case 132:zeroPage(),STY(),burn(3);break;case 40:implied(),PLP(),burn(4);break;case 41:immediate(),AND(),burn(2);break;case 248:implied(),SED(),burn(2);break;case 249:absoluteIndexedY(),SBC(),burn(4);break;case 246:zeroPageIndexedX(),INC(),burn(6);break;case 32:absolute(),JSR(),burn(6);break;case 33:indexedIndirectX(),AND(),burn(6);break;case 38:zeroPage(),ROL(),burn(5);break;case 134:zeroPage(),STX(),burn(3);break;case 36:zeroPage(),BIT(),burn(3);break;case 37:zeroPage(),AND(),burn(2);break;case 53:zeroPageIndexedX(),AND(),burn(3);break;case 54:zeroPageIndexedX(),ROL(),burn(6);break;case 49:indirectIndexedY(),AND(),burn(5);break;case 48:relative(),BMI(),burn(2);break;case 57:absoluteIndexedY(),AND(),burn(4);break;case 56:implied(),SEC(),burn(2);break;case 140:absolute(),STY(),burn(4);break;case 44:absolute(),BIT(),burn(4);break;case 253:absoluteIndexedX(),SBC(),burn(4);break;case 254:absoluteIndexedX(),INC(),burn(7);break;case 45:absolute(),AND(),burn(4);break;case 46:absolute(),ROL(),burn(6);break;case 186:implied(),TSX(),burn(2);break;case 94:absoluteIndexedX(),LSR(),burn(7);break;case 93:absoluteIndexedX(),EOR(),burn(4);break;case 64:implied(),RTI(),burn(6);break;case 65:indexedIndirectX(),EOR(),burn(6);break;case 69:zeroPage(),EOR(),burn(3);break;case 70:zeroPage(),LSR(),burn(5);break;case 72:implied(),PHA(),burn(3);break;case 73:immediate(),EOR(),burn(2);break;case 174:absolute(),LDX(),burn(4);break;case 173:absolute(),LDA(),burn(4);break;case 172:absolute(),LDY(),burn(4);break;case 170:implied(),TAX(),burn(2);break;case 74:accumulator(),LSR(),burn(2);break;case 76:absolute(),JMP(),burn(3);break;case 77:absolute(),EOR(),burn(4);break;case 78:absolute(),LSR(),burn(6);break;case 81:indirectIndexedY(),EOR(),burn(5);break;case 80:relative(),BVC(),burn(2);break;case 86:zeroPageIndexedX(),LSR(),burn(6);break;case 85:zeroPageIndexedX(),EOR(),burn(4);break;case 154:implied(),TXS(),burn(2);break;case 229:zeroPage(),SBC(),burn(3);break;case 89:absoluteIndexedY(),EOR(),burn(4);break;case 88:implied(),CLI(),burn(2);break;case 42:accumulator(),ROL(),burn(2);break;case 169:immediate(),LDA(),burn(2);break;case 168:implied(),TAY(),burn(2);break;case 166:zeroPage(),LDX(),burn(3);break;case 165:zeroPage(),LDA(),burn(3);break;case 162:immediate(),LDX(),burn(2);break;case 161:indexedIndirectX(),LDA(),burn(6);break;case 160:immediate(),LDY(),burn(2);break;case 164:zeroPage(0),LDY(),burn(3);break;case 245:zeroPageIndexedX(),SBC(),burn(4);break;case 126:absoluteIndexedX(),ROR(),burn(7);break;case 125:absoluteIndexedX(),ADC(),burn(4);break;case 240:relative(),BEQ(),burn(2);break;case 104:implied(),PLA(),burn(4);break;case 105:immediate(),ADC(),burn(2);break;case 102:zeroPage(),ROR(),burn(5);break;case 101:zeroPage(),ADC(),burn(3);break;case 96:implied(),RTS(),burn(6);break;case 97:indexedIndirectX(),ADC(),burn(6);break;case 206:absolute(),DEC(),burn(6);break;case 205:absolute(),CMP(),burn(4);break;case 184:implied(),CLV(),burn(2);break;case 185:absoluteIndexedY(),LDA(),burn(4);break;case 202:implied(),DEX(),burn(2);break;case 204:absolute(),CPY(),burn(4);break;case 176:relative(),BCS(),burn(2);break;case 177:indirectIndexedY(),LDA(),burn(5);break;case 182:zeroPageIndexedY(),LDX(),burn(4);break;case 180:zeroPageIndexedX(),LDY(),burn(4);break;case 181:zeroPageIndexedX(),LDA(),burn(4);break;case 138:implied(),TXA(),burn(2);break;case 109:absolute(),ADC(),burn(4);break;case 110:absolute(),ROR(),burn(6);break;case 108:indirect(),JMP(),burn(5);break;case 106:accumulator(),ROR(),burn(2);break;case 121:absoluteIndexedY(),ADC(),burn(4);break;case 120:implied(),SEI(),burn(2);break;case 113:indirectIndexedY(),ADC(),burn(5);break;case 112:relative(),BVS(),burn(2);break;case 117:zeroPageIndexedX(),ADC(),burn(4);break;case 118:zeroPageIndexedX(),ROR(),burn(6);break;case 197:zeroPage(),CMP(),burn(3);break;case 196:zeroPage(),CPY(),burn(3);break;case 198:zeroPage(),DEC(),burn(5);break;case 193:indexedIndirectX(),CMP(),burn(6);break;case 192:immediate(),CPY(),burn(2);break;case 188:absoluteIndexedX(),LDY(),burn(4);break;case 228:zeroPage(),CPX(),burn(3);break;case 201:immediate(),CMP(),burn(2);break;case 200:implied(),INY(),burn(2);break;case 189:absoluteIndexedX(),LDA(),burn(4);break;case 190:absoluteIndexedY(),LDX(),burn(4);break;case 241:indirectIndexedY(),SBC(),burn(5);break;case 233:immediate(),SBC(),burn(2);break;case 208:relative(),BNE(),burn(2);break;case 209:indirectIndexedY(),CMP(),burn(5);break;case 157:absoluteIndexedX(),STA(),burn(5);break;case 8:implied(),PHP(),burn(3);break;case 213:zeroPageIndexedX(),CMP(),burn(4);break;case 214:zeroPageIndexedX(),DEC(),burn(6);break;case 216:implied(),CLD(),burn(2);break;case 217:absoluteIndexedY(),CMP(),burn(4);break;case 6:zeroPage(),ASL(),burn(5);break;case 0:implied(),BRK(),burn(7);break;case 1:indexedIndirectX(),ORA(),burn(6);break;case 236:absolute(),CPX(),burn(4);break;case 5:zeroPage(),ORA(),burn(2);break;case 234:implied(),NOP(),burn(2);break;case 129:indexedIndirectX(),STA(),burn(6);break;case 238:absolute(),INC(),burn(6);break;case 237:absolute(),SBC(),burn(4);break;case 30:absoluteIndexedX(),ASL(),burn(7);break;case 29:absoluteIndexedX(),ORA(),burn(4);break;case 136:implied(),DEY(),burn(2);break;case 9:immediate(),ORA(),burn(2);break;case 141:absolute(),STA(),burn(4);break;case 142:absolute(),STX(),burn(4);break;case 225:indexedIndirectX(),SBC(),burn(6);break;case 224:immediate(),CPX(),burn(2);break;case 230:zeroPage(),INC(),burn(5);break;case 25:absoluteIndexedY(),ORA(),burn(4);break;case 24:implied(),CLC(),burn(2);break;case 22:zeroPageIndexedX(),ASL(),burn(6);break;case 21:zeroPageIndexedX(),ORA(),burn(3);break;case 232:implied(),INX(),burn(2);break;case 17:indirectIndexedY(),ORA(),burn(5);break;case 16:relative(),BPL(),burn(2);break;case 150:zeroPageIndexedY(),STX(),burn(4);break;case 149:zeroPageIndexedX(),STA(),burn(4);break;case 148:zeroPageIndexedX(),STY(),burn(4);break;case 221:absoluteIndexedX(),CMP(),burn(4);break;case 222:absoluteIndexedX(),DEC(),burn(7);break;case 145:indirectIndexedY(),STA(),burn(6);break;case 144:relative(),BCC(),burn(2);break;case 13:absolute(),ORA(),burn(4);break;case 14:absolute(),ASL(),burn(6);break;case 10:accumulator(),ASL(),burn(2);break;case 153:absoluteIndexedY(),STA(),burn(5);break;case 152:implied(),TYA(),burn(2);break;default:PC+=1}}function read(){if(!writeToA&&983040===address)throw new Error("invalid read");return writeToA?A:peek(address)}function modRead(){return write(read())}function write(value){if(writeToA?writeA(value):poke(address,value),value>255)throw new Error("invalid write");return value}function writeA(value){A=value}function implied(){PC+=1}function accumulator(){writeToA=1,PC+=1}function immediate(){address=PC+1,PC+=2}function relative(){address=PC+1,PC+=2}function absolute(){var high=peek(PC+2)<<8,low=peek(PC+1);address=high|low,PC+=3}function zeroPage(index){var base=peek(PC+1);index=index||0,address=base+index&255,PC+=2}function absoluteIndexed(index){var high=peek(PC+2)<<8,low=peek(PC+1),base=high|low;address=base+index&65535,low+X&65280&&burn(1),PC+=3}function absoluteIndexedX(){absoluteIndexed(X)}function absoluteIndexedY(){absoluteIndexed(Y)}function zeroPageIndexedX(){zeroPage(X)}function zeroPageIndexedY(){zeroPage(Y)}function indirect(){var lowAddress=peekWord(PC+1),highAddress=lowAddress+1,low=0,high=0;255===(255&lowAddress)&&(highAddress=lowAddress-255),low=peek(lowAddress),high=peek(highAddress)<<8,address=high|low,PC+=3}function indexedIndirectX(){var peeked=peek(PC+1),newAddress=peeked+X,low=peek(255&newAddress),high=peek(newAddress+1&255)<<8;address=high|low,(65280&peeked)!==(65280&newAddress)&&burn(1),PC+=2}function indirectIndexedY(){var newAddress=peek(PC+1),low=peek(newAddress),high=peek(newAddress+1&255)<<8;address=(high|low)+Y&65535,PC+=2}function ADC(){doADC(read())}function doADC(value){var t=A+value+flagC;flagV=!!((A^t)&(value^t)&128)&&1,flagN=!!(128&t),flagC=t>255,flagZ=!(255&t),writeA(255&t)}function AND(){var value=read();4===value&&(value=value),writeA(A&value),flagN=128&A&&1,flagZ=+(0===A)}function ASL(){var value=modRead(),result=write(value<<1&254);flagC=128&value&&1,flagN=128&result&&1,flagZ=+(0===result)}function BCS(){branch(flagC)}function BCC(){branch(!flagC)}function BEQ(){branch(flagZ)}function BNE(){branch(!flagZ)}function BMI(){branch(flagN)}function BPL(){branch(!flagN)}function BVS(){branch(flagV)}function BVC(){branch(!flagV)}function branch(flag){var offset=read(),prevHigh=PC&HIGH,curHigh=0;flag&&(burn(1),128&offset&&(offset=-complement(offset)),PC+=offset,curHigh=PC&HIGH,prevHigh!==curHigh&&burn(1))}function BIT(){var value=read(),t=A&value;flagN=128&value&&1,flagV=64&value&&1,flagZ=+(0===t)}function BRK(){var high,low;PC+=1,push((PC&HIGH)>>8),push(PC&LOW),setP(),push(16|P),low=peek(65534),high=peek(65535)<<8,PC=high|low}function CLC(){flagC=0}function CLD(){flagD=0}function CLI(){flagI=0,delayInterrupt=!0}function CLV(){flagV=0}function CMP(){xCMP(A)}function CPX(){xCMP(X)}function CPY(){xCMP(Y)}function xCMP(value){var readValue=read(),t=value-readValue&255;flagN=128&t&&1,flagC=+(value>=readValue),flagZ=+(0===t)}function DEC(){var result=write(modRead()-1&255);flagN=+!!(128&result),flagZ=+(0===result)}function DEX(){X=X-1&255,flagZ=+(0===X),flagN=128&X&&1}function DEY(){Y=Y-1&255,flagZ=+(0===Y),flagN=128&Y&&1}function EOR(){writeA(A^read()),flagN=128&A&&1,flagZ=+(0===A)}function INC(){var result=write(modRead()+1&255);flagN=!!(128&result),flagZ=0===result}function INX(){X=X+1&255,flagN=128&X&&1,flagZ=+(0===X)}function INY(){Y=Y+1&255,flagN=128&Y&&1,flagZ=+(0===Y)}function JMP(){PC=address}function JSR(){var t=PC-1;push((t&HIGH)>>8),push(t&LOW),PC=address}function LDA(){var value=read();writeA(value),flagN=128&A&&1,flagZ=+(0===A)}function LDX(){X=read(),flagN=128&X&&1,flagZ=+(0===X)}function LDY(){Y=read(),flagN=128&Y&&1,flagZ=+(0===Y)}function LSR(){var value=modRead();flagN=0,flagC=1&value&&1;var result=write(value>>>1&255);flagZ=+(0===result)}function NOP(){}function ORA(){writeA(A|read()),flagN=128&A&&1,flagZ=+(0===A)}function PHA(){push(A)}function PHP(){setP(),push(16|P)}function PLA(){writeA(pop()),flagN=128&A&&1,flagZ=+(0===A)}function PLP(){P=pop(),setFlags()}function ROL(){var value=modRead(),result=value<<1&254;result=write(result|flagC),flagC=128&value&&1,flagZ=+(0===result),flagN=128&result&&1}function ROR(){var value=modRead(),result=value>>>1&255;result=write(result|(flagC?128:0)),flagC=1&value,flagZ=+(0===result),flagN=128&result&&1}function RTI(){var low,high;P=pop(),setFlags(),low=pop(),high=pop()<<8,PC=high|low}function RTS(){var low,high;low=pop(),high=pop()<<8,PC=(high|low)+1}function SBC(){doADC(255^read())}function SEC(){flagC=1}function SED(){flagD=1}function SEI(){flagI=1}function STA(){write(A)}function STX(){write(X)}function STY(){write(Y)}function TAX(){X=A,flagN=128&X&&1,flagZ=+(0===X)}function TAY(){Y=A,flagN=128&Y&&1,flagZ=+(0===Y)}function TSX(){X=SP,flagN=128&X&&1,flagZ=+(0===X)}function TXA(){writeA(X),flagN=128&A&&1,flagZ=+(0===A)}function TXS(){SP=X}function TYA(){writeA(Y),flagN=128&A&&1,flagZ=+(0===A)}function poke(index,value){system.memory.write(index,value)}function peek(index){return system.memory.read(index)}function peekWord(index){var low=peek(index),high=peek(index+1&65535)<<8;return low|high}function pop(){SP=SP+1&255;var result=peek(256|SP);return result}function push(value){poke(256|SP,value),SP=SP-1&255}function complement(value){return(255&~value)+1}function setFlags(){flagN=!!(128&P),flagV=!!(64&P),flagB=!!(16&P),flagD=!!(8&P),flagI=!!(4&P),flagZ=!!(2&P),flagC=!!(1&P)}function setP(){P=flagN<<7|flagV<<6|32|flagB<<4|flagD<<3|flagI<<2|flagZ<<1|flagC}function setPC(value){PC=value}function resetCycles(){cyclesBurnt=0}function getCycles(){return cyclesBurnt}var address,writeToA,op,cyclesBurnt=0,A=0,X=0,Y=0,SP=0,PC=32768,P=0,debugPC=PC,delayInterrupt=!1,flagI=!1,flagB=!0,flagC=!1,flagN=!0,flagD=!1,flagV=!1,flagZ=!1,irqRequested=!1,nmiRequested=!1,LOW=255,HIGH=65280,VECTOR_NMI=65530,VECTOR_RESET=65532,VECTOR_IRQ=65534;this.burn=burn,this.reset=reset,this.tick=tick,this.setPC=setPC,this.requestNMI=requestNMI,this.requestIRQ=requestIRQ,this.getCycles=getCycles,this.resetCycles=resetCycles,this.execute=execute}module.exports=CPU},{}],14:[function(require,module){function Input(system){this.system=system,this.controllers=system.controllers,this.inputHandlers=new Array(2),this.initConfig(),"undefined"!=typeof window&&this.enable()}var Keyboard=require("./keyboard"),StandardController=require("../controllers/standardcontroller");Input.prototype={enable:function(){this._setEnabled(!0)},disable:function(){this._setEnabled(!1)},_setEnabled:function(enabled){
for(var handler,method=enabled?"enable":"disable",i=0;i<this.inputHandlers.length;i++)handler=this.inputHandlers[i],handler&&handler[method]()},initConfig:function(){for(var item,config=this.config=this.system.config.input,i=0;i<config.length;i++)item=config[i],this.setController(i,item.type),this.setInputHandler(i,item.input,item.config)},setController:function(index,type){var Controller=controllerMap[type];this.controllers.connect(index,new Controller)},setInputHandler:function(index,input,config){var InputHandler=inputHandlerMap[input],controller=this.controllers.get(index);this.inputHandlers[index]=new InputHandler(controller,config)}};var controllerMap={standard:StandardController},inputHandlerMap={keyboard:Keyboard};module.exports=Input},{"../controllers/standardcontroller":12,"./keyboard":15}],15:[function(require,module){function Keyboard(controller,config){this.controller=controller,this.handlers={},config&&this.configure(config),this.enabled=!1}Keyboard.prototype={configure:function(config){this.config=config,this.initKeyCodes()},enable:function(){this.enabled||(this.bindHandler("keydown"),this.bindHandler("keyup")),this.enabled=!0},disable:function(){this.unbindHandler("keydown"),this.unbindHandler("keyup"),this.enabled=!1},bindHandler:function(type){window.addEventListener(type,this.getHandler(type))},unbindHandler:function(type){window.removeEventListener(type,this.getHandler(type))},getHandler:function(type){if(this.handlers[type])return this.handlers[type];var self=this,handler="keydown"===type?"press":"depress";return this.handlers[type]=function(e){var keyCode=e.keyCode;keyCode in self.keyCodes&&(self.controller[handler](self.keyCodes[keyCode]),e.preventDefault())},this.handlers[type]},initKeyCodes:function(){var name,keyCode,keyCodes={};for(name in this.config)keyCode=name in keyCodeMap?keyCodeMap[name]:name.toUpperCase().charCodeAt(),keyCodes[keyCode]=this.config[name];this.keyCodes=keyCodes}};var keyCodeMap={backspace:8,tab:9,"return":13,shift:16,ctrl:17,alt:18,capslock:20,space:32,left:37,up:38,right:39,down:40};module.exports=Keyboard},{}],16:[function(require,module){module.exports={init:function(){this.axRomBanks=this.prgBanks>>1,this.setPrgBank(0)},setPrgBank:function(bank){this.prgBank=bank,this.loadPRGBank(32768,bank,32768)},writeRegister:function(address,value){this.setPrgBank(7&value),this.mirroring=16&value?4:3}}},{}],17:[function(require,module,exports){var NROM=require("./nrom"),MMC1=require("./mmc1"),MMC2=require("./mmc2"),MMC3=require("./mmc3"),UxROM=require("./uxrom"),AxROM=require("./axrom"),mapperList={};mapperList[0]=NROM,mapperList[1]=MMC1,mapperList[2]=UxROM,mapperList[4]=MMC3,mapperList[7]=AxROM,mapperList[9]=MMC2,exports.init=function(cartridge){var mapper,method,mapperID=cartridge.mapper;if(!(mapperID in mapperList))throw new Error("Unknown mapper "+mapperID);mapper=mapperList[mapperID];for(method in mapper)cartridge[method]=mapper[method];cartridge.init()}},{"./axrom":16,"./mmc1":18,"./mmc2":19,"./mmc3":20,"./nrom":21,"./uxrom":22}],18:[function(require,module){var mirrorMap=[3,4,1,0];module.exports={init:function(){this.lastPRG=this.prgBanks-1,this.prgBank=0,this.chrBank0=0,this.chrBank1=1,this.registerWrites=0,this.registerShift=0,this.mapperControl(12)},mapperControl:function(value){var mirroring=3&value,prgMode=(12&value)>>2,chrMode=(16&value)>>4;this.mapperFlags=value,this.mirroring=mirrorMap[mirroring],this.prgMode=prgMode,this.chrMode=chrMode,this.setPRGBanks()},setRegister:function(address,value){switch(24576&address){case 0:this.mapperControl(value);break;case 8192:this.chrBank0=value,this.setChrBanks();break;case 16384:this.chrBank1=value,this.setChrBanks();break;case 24576:value&=15,this.prgBank=value,this.setPRGBanks()}this.registerWrites=0,this.registerShift=0},setPRGBanks:function(){var bank0,bank1;switch(this.prgMode){case 0:case 1:bank0=-2&this.prgBank,bank1=this.prgBank+1;break;case 2:bank0=0,bank1=this.prgBank;break;case 3:bank0=this.prgBank,bank1=this.lastPRG}this.loadPRGBank(32768,bank0,16384),this.loadPRGBank(49152,bank1,16384)},setChrBanks:function(){var bank0,bank1;this.chrMode?(bank0=this.chrBank0,bank1=this.chrBank1,this.chrBanks<2&&(bank0&=1,bank1&=1)):(bank0=-2&this.chrBank0,bank1=bank0+1),this.loadCHRBank(0,bank0,4096),this.loadCHRBank(4096,bank1,4096)},writeRegister:function(address,value){128&value?(this.registerShift=0,this.registerWrites=0,this.mapperControl(12|this.mapperFlags)):(this.registerShift=this.registerShift>>1|(1&value)<<4,this.registerWrites++,5===this.registerWrites&&this.setRegister(address,this.registerShift))}}},{}],19:[function(require,module){module.exports={init:function(){this.setPrgBank(0),this.mmc2PRG=this.prgBanks<<1,this.loadPRGBank(40960,this.mmc2PRG-3,8192),this.loadPRGBank(49152,this.mmc2PRG-2,8192),this.loadPRGBank(57344,this.mmc2PRG-1,8192),this.chrLatch0=!1,this.chrLatch1=!1,this.chrBank0=this.chrBank1=0,this.chrBank2=this.chrBank3=0,this.chrBankA=this.chrBank0,this.chrBankB=this.chrBank1,this.setChrBanks(),this.initLatchSwitches(),this._readCHR=Object.getPrototypeOf(this).readCHR},initLatchSwitches:function(){var i,switches=new Uint8Array(8192);for(switches[4056]=1,switches[4072]=2,i=8152;8160>i;i++)switches[i]=3;for(i=8168;8176>i;i++)switches[i]=4;this.latchSwitches=switches},setChrBanks:function(){var bank0=this.chrLatch0?this.chrBank1:this.chrBank0,bank1=this.chrLatch1?this.chrBank3:this.chrBank2;this.loadCHRBank(0,bank0,4096),this.loadCHRBank(4096,bank1,4096)},setPrgBank:function(bank){this.prgBank=bank,this.loadPRGBank(32768,this.prgBank,8192)},writeRegister:function(address,value){switch(28672&address){case 8192:this.setPrgBank(15&value);break;case 12288:this.chrBank0=31&value;break;case 16384:this.chrBank1=31&value;break;case 20480:this.chrBank2=31&value;break;case 24576:this.chrBank3=31&value;break;case 28672:this.mirroring=+!(1&value)}this.setChrBanks()},readCHR:function(address){var value=this._readCHR(address);switch(this.latchSwitches[address]){case 0:break;case 1:this.chrLatch0&&(this.chrLatch0=!1,this.setChrBanks());break;case 2:this.chrLatch0||(this.chrLatch0=!0,this.setChrBanks());break;case 3:this.chrLatch1&&(this.chrLatch1=!1,this.setChrBanks());break;case 4:this.chrLatch1||(this.chrLatch1=!0,this.setChrBanks())}return value}}},{}],20:[function(require,module){module.exports={init:function(){this.lastA14=0,this.irqEnabled=!1,this.irqCounter=0,this.irqCounterReset=0,this.willReloadIRQ=!1,this.prgBank0=0,this.prgBank1=1,this.prgBase0=32768,this.prgBase1=40960,this.mmc3PRG=this.prgBanks<<1,this.lastPRG=this.mmc3PRG-1,this.lastPRG2=this.lastPRG-1,this.mmc3CHR=this.chrBanks<<3,this.setBankSelect(0),this._readCHR=Object.getPrototypeOf(this).readCHR},setBankSelect:function(value){var prgMode=+!!(64&value),chrMode=+!!(128&value);this.bankSelectMode=7&value,prgMode!==this.prgMode&&this.setPRGMode(prgMode),chrMode!==this.chrMode&&this.setCHRMode(chrMode)},setPRGMode:function(mode){this.prgMode=mode,mode?(this.loadPRGBank(32768,this.lastPRG2,8192),this.prgBase0=49152):(this.loadPRGBank(49152,this.lastPRG2,8192),this.prgBase0=32768),this.loadPRGBank(57344,this.lastPRG,8192),this.prgBase1=40960,this.setPRGBanks()},setBank:function(value){var bank=0,base=0;switch(this.bankSelectMode){case 1:bank=1;case 0:base=this.chrBigBase+2048*bank,this.loadCHRBank(base,-2&value,1024),this.loadCHRBank(base+1024,1|value,1024);break;case 2:case 3:case 4:case 5:bank=this.bankSelectMode-2,base=this.chrSmallBase+1024*bank,this.loadCHRBank(base,value,1024);break;case 6:this.prgBank0=value&this.mmc3PRG-1,this.setPRGBanks();break;case 7:this.prgBank1=value&this.mmc3PRG-1,this.setPRGBanks()}},setPRGBanks:function(){this.loadPRGBank(this.prgBase0,this.prgBank0,8192),this.loadPRGBank(this.prgBase1,this.prgBank1,8192)},setCHRMode:function(mode){this.chrMode=mode,mode?(this.chrBigBase=4096,this.chrSmallBase=0):(this.chrBigBase=0,this.chrSmallBase=4096)},setMirroring:function(value){this.mirroring=+!(1&value)},setRAMProtect:function(){},reloadIRQ:function(){this.willReloadIRQ=!0},setIRQCounter:function(value){this.irqCounterReset=value},enableIRQ:function(enabled){this.irqEnabled=enabled},writeRegister:function(address,value){var odd=1&address;switch(24576&address){case 0:odd?this.setBank(value):this.setBankSelect(value);break;case 8192:odd?this.setRAMProtect(value):this.setMirroring(value);break;case 16384:odd?this.reloadIRQ():this.setIRQCounter(value);break;case 24576:this.enableIRQ(!!odd)}},readCHR:function(address){var a14=4096&address;return a14&&a14!==this.lastA14&&this.clockScanlineCounter(),this.lastA14=a14,this._readCHR(address)},clockScanlineCounter:function(){this.willReloadIRQ||!this.irqCounter?(this.irqCounter=this.irqCounterReset,this.willReloadIRQ=!1):(this.irqCounter--,!this.irqCounter&&this.irqEnabled&&this.system.cpu.requestIRQ())}}},{}],21:[function(require,module){module.exports={init:function(){var nrom128=1===this.prgBanks;nrom128?(this.loadPRGBank(32768,0,16384),this.loadPRGBank(49152,0,16384)):this.loadPRGBank(32768,0,32768)},readCHR:function(address){return this.chrData[address]},writeCHR:function(address,value){return this.chrBanks||(this.chrData[address]=value),value}}},{}],22:[function(require,module){module.exports={init:function(){this.prgBank=0,this.loadPRGBank(32768,this.prgBank,16384),this.loadPRGBank(49152,this.prgBanks-1,16384)},writeRegister:function(address,value){this.prgBank=15&value,this.loadPRGBank(32768,this.prgBank,16384)}}},{}],23:[function(require,module){"use strict";function Memory(system){var i=0;for(this.system=system,this.ram=new Uint8Array(2048);2048>i;i++)this.ram[i]=255;this.address=0,this.cartridge=null,Object.preventExtensions(this)}Memory.prototype={loadCartridge:function(cartridge){this.cartridge=cartridge},readWrite:function(address,write,value){switch(this.address=address,address){case 16404:if(write){var i,base=value<<8;for(i=0;256>i;i++)this.write(8196,this.read(base+i));this.system.cpu.burn(513)}return 0;case 16406:return write?(this.system.controllers.write(value),0):this.system.controllers.read(0);case 16407:if(!write)return this.system.controllers.read(1)}return address>=16416?write?this.system.cartridge.writePRG(address,value):this.system.cartridge.readPRG(address):8192>address?(address&=2047,write?(this.ram[address]=value,0):this.ram[address]):16384>address?(address&=7,write?this.system.ppu.writeRegister(address,value):this.system.ppu.readRegister(address)):(address&=255,write?this.system.apu.writeRegister(address,value):this.system.apu.readRegister(address))},read:function(address){return this.readWrite(address,!1,0)},write:function(address,value){return this.readWrite(address,!0,value)}},module.exports=Memory},{}],24:[function(require,module){function AudioOutput(){this.bufferIndex=0,this.bufferLength=8192,this.sampleRate=44100,this.volume=1,this.playing=null,this.setEnabled(!0)}AudioOutput.prototype={writeSample:function(sample){this.bufferData[this.bufferIndex++]=sample,this.bufferIndex===this.bufferLength&&(this.bufferIndex=0,this.playing&&this.playing.stop(),this.bufferSource.buffer=this.buffer,this.playing=this.bufferSource,this.playing.start(0),this.initBuffer())},setEnabled:function(enabled){this.enabled=enabled&&this.isSupported(),this.enabled&&(this.initContext(),this.initBuffer())},setVolume:function(value){this.gainNode.gain.value=value,this.volume=value},initContext:function(){this.context=new AudioContext,this.sampleRate=this.context.sampleRate,this.gainNode=this.context.createGain(),this.gainNode.connect(this.context.destination)},initBuffer:function(){this.buffer=this.context.createBuffer(1,this.bufferLength,this.context.sampleRate),this.bufferData=this.buffer.getChannelData(0),this.bufferSource=this.context.createBufferSource(),this.bufferSource.connect(this.gainNode)},isSupported:function(){return"undefined"!=typeof AudioContext}},module.exports=AudioOutput},{}],25:[function(require,module){function Output(){this.audio=new AudioOutput,this.video=new VideoOutput}var AudioOutput=require("./audiooutput"),VideoOutput=require("./videooutput");module.exports=Output},{"./audiooutput":24,"./videooutput":29}],26:[function(require,module){function Canvas2DRenderer(el){this.el=el,this.initData(),this.initPalette()}function getContext(el){return el.getContext("2d")}var palette=require("./palette").data;Canvas2DRenderer.isSupported=function(el){return!!getContext(el)},Canvas2DRenderer.prototype={renderFrame:function(output){var bgBuffer=output.bgBuffer,spriteBuffer=output.spriteBuffer,prioBuffer=output.prioBuffer,bgColor=output.bgColor,reds=this.reds,greens=this.greens,blues=this.blues,end=bgBuffer.length;data=this.data;for(var pixelIndex=0,outputIndex=0,color=0;end>pixelIndex;pixelIndex++)color=bgBuffer[pixelIndex],!spriteBuffer[pixelIndex]||prioBuffer[pixelIndex]&&color||(color=spriteBuffer[pixelIndex]),color=color||bgColor,data[outputIndex++]=reds[color],data[outputIndex++]=greens[color],data[outputIndex++]=blues[color],outputIndex++;this.image.data.set(data),this.context.putImageData(this.image,0,0)},initData:function(){this.width=256,this.height=224,this.data=new Uint8Array(this.width*this.height*4);for(var i=0;i<this.data.length;i++)this.data[i]=255;this.context=getContext(this.el),this.image=this.context.getImageData(0,0,this.width,this.height),this.index=0},initPalette:function(){var color=0,i=0,address=0,view=palette,buffer=new ArrayBuffer(192),splitPalette=new Uint8Array(buffer);for(color=0;3>color;color+=1)for(i=0;192>i;i+=3)splitPalette[address]=view[i+color],address+=1;this.palette=view,this.reds=new Uint8Array(buffer,0,64),this.greens=new Uint8Array(buffer,64,64),this.blues=new Uint8Array(buffer,128,64)}},module.exports=Canvas2DRenderer},{"./palette":27}],27:[function(require,module,exports){exports.data=new Uint8Array([102,102,102,0,42,136,20,18,167,59,0,164,92,0,126,110,0,64,108,7,0,86,29,0,51,53,0,12,72,0,0,82,0,0,79,8,0,64,77,0,0,0,0,0,0,0,0,0,173,173,173,21,95,217,66,64,255,117,39,254,160,26,204,183,30,123,181,49,32,153,78,0,107,109,0,56,135,0,13,147,0,0,143,50,0,124,141,0,0,0,0,0,0,0,0,0,255,255,255,100,176,255,146,144,255,198,118,255,242,106,255,255,110,204,255,129,112,234,158,34,188,190,0,136,216,0,92,228,48,69,224,130,72,205,222,79,79,79,0,0,0,0,0,0,255,255,255,192,223,255,211,210,255,232,200,255,250,194,255,255,196,234,255,204,197,247,216,165,228,229,148,207,239,150,189,244,171,179,243,204,181,235,242,184,184,184,0,0,0,0,0,0])},{}],28:[function(require,module){function WebGLRenderer(el){this.el=el,this.initGL()}function getGL(el){return el.getContext("webgl")||el.getContext("experimental-webgl")}var palette=require("./palette").data;WebGLRenderer.isSupported=function(el){return!!getGL(el)},WebGLRenderer.prototype={renderFrame:function(output){var gl=this.gl;gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.bgTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.LUMINANCE,256,224,0,gl.LUMINANCE,gl.UNSIGNED_BYTE,output.bgBuffer),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,this.spriteTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.LUMINANCE,256,224,0,gl.LUMINANCE,gl.UNSIGNED_BYTE,output.spriteBuffer),gl.activeTexture(gl.TEXTURE2),gl.bindTexture(gl.TEXTURE_2D,this.prioTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.LUMINANCE,256,224,0,gl.LUMINANCE,gl.UNSIGNED_BYTE,output.prioBuffer),gl.activeTexture(gl.TEXTURE3),gl.bindTexture(gl.TEXTURE_2D,this.paletteTexture);var positionLocation=gl.getAttribLocation(this.program,"vertCoord");gl.enableVertexAttribArray(positionLocation),gl.vertexAttribPointer(positionLocation,2,gl.FLOAT,!1,0,0);var color=3*output.bgColor;gl.uniform4f(this.bgColorLocation,palette[color]/256,palette[color+1]/256,palette[color+2]/256,1),gl.drawArrays(gl.TRIANGLES,0,6)},initGL:function(){var gl=this.gl=getGL(this.el);gl.viewport(0,0,256,224),this.initShaders(),this.initProgram(),this.initBuffers(),this.initTextures(),this.bgColorLocation=gl.getUniformLocation(this.program,"bgColor")},initBuffers:function(){var gl=this.gl,buffer=this.buffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),gl.STATIC_DRAW)},initTextures:function(){function createTexture(index,name){var texture=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.uniform1i(gl.getUniformLocation(program,name),index),texture}var gl=this.gl,program=this.program;this.bgTexture=createTexture(0,"bgTexture"),this.spriteTexture=createTexture(1,"spriteTexture"),this.prioTexture=createTexture(2,"prioTexture"),this.paletteTexture=createTexture(3,"paletteTexture"),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,64,1,0,gl.RGB,gl.UNSIGNED_BYTE,palette)},initShaders:function(){function compileShader(shaderType,shaderSource){var shader=gl.createShader(shaderType);if(gl.shaderSource(shader,shaderSource),gl.compileShader(shader),!gl.getShaderParameter(shader,gl.COMPILE_STATUS))throw"An error occurred compiling the shaders: "+gl.getShaderInfoLog(shader);return shader}var gl=this.gl,fragmentShaderSource=["precision mediump float;","uniform sampler2D bgTexture;","uniform sampler2D spriteTexture;","uniform sampler2D prioTexture;","uniform sampler2D paletteTexture;","uniform vec4 bgColor;","varying vec2 texCoord;","void main(void) {","float bgIndex = texture2D(bgTexture, texCoord).r;","float spriteIndex = texture2D(spriteTexture, texCoord).r;","float prioIndex = texture2D(prioTexture, texCoord).r;","float colorIndex = ((spriteIndex > 0.0 && (prioIndex == 0.0 || bgIndex == 0.0)) ? spriteIndex : bgIndex);","vec4 color = texture2D(paletteTexture, vec2( colorIndex * 4.0 + 0.0078, 0.5));","if ( colorIndex > 0.0 ) {","gl_FragColor = color;","} else {","gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);","gl_FragColor = bgColor;","}","}"].join("\n"),vertexShaderSource=["attribute vec2 vertCoord;","varying vec2 texCoord;","void main() {","gl_Position = vec4(vertCoord, 0, 1);","texCoord = vec2( 0.5 * ( vertCoord.x + 1.0 ), 0.5 * (1.0 - vertCoord.y));","}"].join("");this.fragmentShader=compileShader(gl.FRAGMENT_SHADER,fragmentShaderSource),this.vertexShader=compileShader(gl.VERTEX_SHADER,vertexShaderSource)},initProgram:function(){var gl=this.gl,program=gl.createProgram();gl.attachShader(program,this.vertexShader),gl.attachShader(program,this.fragmentShader),gl.linkProgram(program),gl.useProgram(program),this.program=program}},module.exports=WebGLRenderer},{"./palette":27}],29:[function(require,module){function VideoOutput(){var width=256,height=225,length=width*height;this.pixelBuffer=new Uint8Array(length),this.bgBuffer=new Uint8Array(length),this.spriteBuffer=new Uint8Array(length),this.prioBuffer=new Uint8Array(length),this.index=0,this.bgColor=0}var WebGLRenderer=require("./renderer/webgl"),Canvas2DRenderer=require("./renderer/canvas2d");VideoOutput.prototype={force2D:!1,run:function(){var self=this;requestAnimationFrame(function flush(){requestAnimationFrame(flush),self.renderer.renderFrame(self)})},reset:function(bgColor){this.index=0,this.bgColor=bgColor},setIntensity:function(){},setGrayscale:function(){},outputScanline:function(background,sprites,priorities){this.bgBuffer.set(background,this.index),this.spriteBuffer.set(sprites,this.index),this.prioBuffer.set(priorities,this.index),this.index+=256},setElement:function(el){this.el=el,this.initRenderer()},initRenderer:function(){if(!this.force2D&&WebGLRenderer.isSupported(this.el))this.renderer=new WebGLRenderer(this.el);else{if(!Canvas2DRenderer.isSupported(this.el))throw new Error("No supported renderer!");this.renderer=new Canvas2DRenderer(this.el)}}},module.exports=VideoOutput},{"./renderer/canvas2d":26,"./renderer/webgl":28}],30:[function(require,module){"use strict";function Background(ppu){this.ppu=ppu,this.memory=ppu.memory,this.enabled=!0,this.enabledLeft=!0,this.pixelOffset=0,this.loopyV=0,this.loopyT=0,this.loopyW=0,this.loopyX=0,this.baseTable=0,this.x=0,this.y=0,this.scanlineColors=new Uint8Array(256),this.scanlineReset=new Uint8Array(256),Object.preventExtensions(this)}function initAttrAddresses(){var i,result=new Uint16Array(32768);for(i=0;32768>i;i++)result[i]=9152|3072&i|i>>4&56|i>>2&7;return result}function initMasks(){var i,mask,result=new Uint8Array(65536);for(i=0;65536>i;i++)mask=3,2&i&&(mask<<=2),64&i&&(mask<<=4),result[i]=mask;return result}function initPalettes(){var i,j,result=new Uint8Array(256);for(i=0;4>i;i++)for(j=0;8>j;j+=2)result[i<<j]=i<<2;return result}function initTileCycles(){var i,result=new Uint8Array(400);for(i=7;256>i;i+=8)result[i]=1;for(i=327;336>i;i+=8)result[i]=1;return result}var bitmap=require("../utils/bitmap"),NAMETABLE_BITMASK=3072,NAMETABLE_RESET=~NAMETABLE_BITMASK,attrAddresses=initAttrAddresses(),tileCycles=initTileCycles(),palettes=initPalettes(),masks=initMasks();Background.prototype={toggle:function(flag){this.enabled=!!flag},toggleLeft:function(flag){this.enabledLeft=!!flag},writeAddress:function(value){this.loopyW?(value&=255,this.loopyT=65280&this.loopyT|value,this.loopyV=this.loopyT):(value&=63,value<<=8,this.loopyT=255&this.loopyT|value),this.loopyW=!this.loopyW},writeScroll:function(value){this.loopyW?(this.loopyT=-29665&this.loopyT,this.loopyT=this.loopyT|(7&value)<<12,this.loopyT=this.loopyT|(248&value)<<2,this.loopyW=0):(this.loopyT=32736&this.loopyT,this.loopyT|=value>>3,this.loopyX=7&value,this.loopyW=1)},evaluate:function(){var ppu=this.ppu,lineCycle=ppu.lineCycle;tileCycles[lineCycle]&&this.fetchTile(),-1===ppu.scanline&&lineCycle>280&&304>lineCycle&&(this.loopyV=1055&this.loopyV|31712&this.loopyT)},initScanline:function(){this.pixelOffset=this.enabledLeft?0:8},endScanline:function(){this.incrementVY(),this.loopyV=31712&this.loopyV|1055&this.loopyT,this.scanlineColors.set(this.scanlineReset),this.x=-this.loopyX},incrementVX:function(){31===(31&this.loopyV)?this.loopyV=65504&this.loopyV^1024:this.loopyV+=1,this.x+=8},incrementVY:function(){if(28672!=(28672&this.loopyV))this.loopyV+=4096;else{this.loopyV&=-28673;var coarseY=(992&this.loopyV)>>>5;29==coarseY?(coarseY=0,this.loopyV^=2048):31==coarseY?coarseY=0:coarseY+=1,this.loopyV=-993&this.loopyV|coarseY<<5}this.y=(28672&this.loopyV)>>12},fetchTile:function(){var cartridge=this.memory.cartridge,attrAddress=attrAddresses[this.loopyV],attribute=cartridge.readNameTable(8191&attrAddress),nametableAddress=8192|4095&this.loopyV,tileIndex=cartridge.readNameTable(8191&nametableAddress),tile=cartridge.readTile(this.baseTable,tileIndex,this.y);tile&&this.renderTile(tile,palettes[attribute&masks[4095&this.loopyV]]),this.incrementVX()},renderTile:function(tile,palette){for(var colors=bitmap.getColors(tile),color=0,begin=Math.max(this.pixelOffset,this.x),end=Math.min(255,this.x+7),i=7-(end-begin);end>=begin;end--)color=colors[i++],color&&(this.scanlineColors[end]=this.ppu.memory.palette[palette|color])},setNameTable:function(index){this.loopyT=this.loopyT&NAMETABLE_RESET|index<<10}},module.exports=Background},{"../utils/bitmap":34}],31:[function(require,module){"use strict";function PPU(system){this.system=system,this.ram=new Uint8Array(2048),this.enabled=!0,this.frameEnded=!1,this.vBlank=!1,this.warmup=2,this.scanline=-1,this.lineCycle=0,this.increment=1,this.masterSlave=0,this.generateNMI=!1,this.sprite0Hit=!1,this.nmiOccurred=!1,this.checkNMI=!1,this.pixelInRange=!1,this.yInRange=!1,this.inRenderScanline=!0,this.readBuffer=0,this.countdown=0,this.memory=new Memory(this),this.background=new Background(this),this.sprites=new Sprites(this),this.output=this.system.output.video,Object.preventExtensions(this)}var Background=require("./background"),Sprites=require("./sprites"),Memory=require("./memory");PPU.prototype={readStatus:function(){var result=!!this.nmiOccurred<<7|!!this.sprite0Hit<<6|!!this.sprites.spriteOverflow<<5;return this.nmiOccurred=!1,result},mask:function(value){this.output.setGrayscale(1&value),this.output.setIntensity(32&value,64&value,128&value),this.sprites.toggle(16&value),this.sprites.toggleLeft(4&value),this.background.toggle(8&value),this.background.toggleLeft(2&value),this.enabled=this.sprites.enabled||this.background.enabled},control:function(value){var nametableFlag=3&value,incrementFlag=4&value,spriteFlag=8&value,backgroundFlag=16&value,sizeFlag=32&value,nmiFlag=128&value;this.background.setNameTable(nametableFlag),this.increment=incrementFlag?32:1,this.sprites.baseTable=spriteFlag?4096:0,this.background.baseTable=backgroundFlag?4096:0,this.sprites.spriteSize=sizeFlag?16:8,this.generateNMI=!!nmiFlag},readRegister:function(address){var result;switch(address){case 2:return result=this.readStatus(),this.background.loopyW=0,result;case 4:return this.sprites.readOAM();case 7:return result=this.readBuffer,this.readBuffer=this.memory.read(this.background.loopyV),16128===(16128&this.background.loopyV)&&(result=this.readBuffer,this.readBuffer=this.memory.read(12287&this.background.loopyV)),this.background.loopyV+=this.increment,result}},writeRegister:function(address,value){switch(address){case 0:this.control(value);break;case 1:this.mask(value);break;case 3:this.sprites.oamAddress=value;break;case 4:this.sprites.writeOAM(value);break;case 5:this.background.writeScroll(value);break;case 6:this.background.writeAddress(value);break;case 7:this.memory.write(this.background.loopyV,value),this.background.loopyV+=this.increment}},tick:function(){var sprites=this.sprites,background=this.background;this.inRenderScanline?(this.enabled&&(background.evaluate(),sprites.evaluate()),this.pixelInRange&&this.pixelInRange&&sprites.sprite0InRange&&sprites.scanlineSprite0[this.lineCycle-1]&&!this.sprite0Hit&&(this.sprite0Hit=!!background.scanlineColors[this.lineCycle-1]),this.incrementRenderCycle()):this.incrementIdleCycle()},incrementRenderCycle:function(){switch(++this.lineCycle){case 1:this.background.initScanline(),this.sprites.initScanline(),this.pixelInRange=this.yInRange;break;case 257:this.pixelInRange=!1,this.yInRange&&this.output.outputScanline(this.background.scanlineColors,this.sprites.scanlineColors,this.sprites.scanlinePriority),this.enabled&&(this.background.endScanline(),this.sprites.endScanline());break;case 341:this.incrementScanline()}},incrementIdleCycle:function(){this.countdown--||(this.scanline=-1,this.frameEnded=!0,this.inRenderScanline=!0,this.vBlank=this.nmiOccurred=!1,this.checkNMI=!1,this.sprites.spriteOverflow=!1,this.sprite0Hit=!1)},incrementScanline:function(){switch(this.scanline++,this.lineCycle=0,this.scanline){case 8:this.output.reset(this.memory.palette[0]),this.yInRange=!0;break;case 233:this.yInRange=!1;break;case 240:this.inRenderScanline=!1,this.vBlank=this.nmiOccurred=this.checkNMI=!0,this.generateNMI&&this.system.cpu.requestNMI(),this.countdown=6800}}},module.exports=PPU},{"./background":30,"./memory":32,"./sprites":33}],32:[function(require,module){"use strict";function Memory(ppu){this.ppu=ppu,this.system=ppu.system,this.palette=new Uint8Array(32),this.cartridge=null,Object.preventExtensions(this)}Memory.prototype={loadCartridge:function(cartridge){this.cartridge=cartridge},read:function(address){return this._readWrite(address,0,0)},write:function(address,value){this._readWrite(address,value,1)},_readWrite:function(address,value,write){var relativeAddress=0;return address&=16383,-8192&address?-12288&address?16128>address?this._readWrite(address-4096,value,write):16383>address?(relativeAddress=31&address,0===(3&relativeAddress)&&(relativeAddress&=-17),write?(this.palette[relativeAddress]=value,0):this.palette[relativeAddress]):void 0:(relativeAddress=8191&address,write?(this.cartridge.writeNameTable(relativeAddress,value),0):this.cartridge.readNameTable(relativeAddress)):write?this.cartridge.writeCHR(address,value):this.cartridge.readCHR(address)}},module.exports=Memory},{}],33:[function(require,module){"use strict";function Sprites(ppu){this.ppu=ppu,this.memory=ppu.memory,this.enabled=!0,this.enabledLeft=!0,this.pixelOffset=0,this.oamAddress=0,this.oam=new Uint8Array(256),this.oam2=new Uint8Array(33),this.oam2reset=new Uint8Array(this.oam2.length);for(var i=0;i<this.oam2reset.length;i++)this.oam2reset[i]=255;this.spriteProgress=0,this.currentSprite=0,this.spriteSize=8,this.baseTable=0,this.sprite0Next=!1,this.sprite0InRange=!1,this.spriteOverflow=!1,this.scanlineOverflow=!1,this.spriteCount=0,this.nextSpriteCount=0,this.yCounters=new Uint8Array(64),this.yCountersReset=new Uint8Array(this.yCounters.length),this.nextScanlineSprite0=new Uint8Array(256),this.nextScanlinePriority=new Uint8Array(256),this.nextScanlineColors=new Uint8Array(256),this.scanlineSprite0=new Uint8Array(256),this.scanlinePriority=new Uint8Array(256),this.scanlineColors=new Uint8Array(256),this.scanlineReset=new Uint8Array(this.scanlineColors.length),Object.preventExtensions(this)}function initTileCycles(){var i,result=new Uint8Array(512);for(i=264;320>=i;i+=8)result[i]=1;return result}var bitmap=require("../utils/bitmap"),tileCycles=initTileCycles();Sprites.prototype={toggle:function(flag){this.enabled=!!flag},toggleLeft:function(flag){this.enabledLeft=!!flag},evaluate:function(){tileCycles[this.ppu.lineCycle]&&this.fetchTile()},initScanline:function(){this.currentSprite=0,this.sprite0InRange=this.sprite0Next,this.sprite0Next=!1,this.scanlineOverflow=!1,this.oamAddress=0,this.clearSecondaryOAM(),this.scanlineSprite0.set(this.nextScanlineSprite0),this.scanlinePriority.set(this.nextScanlinePriority),this.scanlineColors.set(this.nextScanlineColors),this.nextSpriteCount&&(this.nextScanlineSprite0.set(this.scanlineReset),this.nextScanlinePriority.set(this.scanlineReset),this.nextScanlineColors.set(this.scanlineReset)),this.spriteCount=this.nextSpriteCount,this.nextSpriteCount=0},endScanline:function(){this.initSecondaryOAM()},readOAM:function(){return this.ppu.vBlank?this.oam[this.oamAddress]:0},writeOAM:function(value){this.ppu.vBlank&&(this.oam[this.oamAddress]=value,this.oamAddress=this.oamAddress+1&255)},clearSecondaryOAM:function(){this.oam2.set(this.oam2reset),-1===this.ppu.scanline&&this.yCounters.set(this.yCountersReset)},initSecondaryOAM:function(){var ppu=this.ppu;if(ppu.enabled){for(var value,oam2Index=0,index=this.oamAddress,n=0;64>n;n++)value=this.oam[index],this.oam2[oam2Index]=value,ppu.scanline===value&&(this.yCounters[n]=this.spriteSize),this.yCounters[n]&&(this.scanlineOverflow?this.spriteOverflow=!0:(this.oam2.set(this.oam.subarray(index,index+4),oam2Index),0===n&&(this.sprite0Next=!0),this.nextSpriteCount++,oam2Index+=4,32===oam2Index&&(this.scanlineOverflow=!0)),this.yCounters[n]--),index+=4;this.oamAddress=index,this.oam2[oam2Index]=0}},fetchTile:function(){var spriteIndex=this.currentSprite<<2,y=this.oam2[spriteIndex],tileIndex=this.oam2[spriteIndex+1],attributes=this.oam2[spriteIndex+2],x=this.oam2[spriteIndex+3],baseTable=this.baseTable,tile=0,flipX=64&attributes,flipY=0,fineY=0;flipY=128&attributes,fineY=this.ppu.scanline-y&this.spriteSize-1,16===this.spriteSize&&(baseTable=1&tileIndex?4096:0,tileIndex=-2&tileIndex,fineY>7?(fineY-=8,flipY||tileIndex++):flipY&&tileIndex++),flipY&&(fineY=8-fineY-1),tile=this.memory.cartridge.readTile(baseTable,tileIndex,fineY),flipX&&(tile=bitmap.reverseTile(tile)),this.currentSprite<this.nextSpriteCount&&this.renderTile(x,tile,attributes),this.currentSprite+=1},renderTile:function(x,tile,attributes){for(var colors=bitmap.getColors(tile),palette=16|(3&attributes)<<2,priority=32&attributes,sprite0=0===this.currentSprite&&this.sprite0Next,color=0,i=8;i>=0&&x>=this.pixelOffset&&256>x;i--)this.nextScanlineColors[x]||(color=colors[i],color&&(this.nextScanlineColors[x]=this.ppu.memory.palette[palette|color],this.nextScanlinePriority[x]=priority,this.nextScanlineSprite0[x]=sprite0)),x++}},module.exports=Sprites},{"../utils/bitmap":34}],34:[function(require,module,exports){function reverseByte(byte){return reversedBytes[byte]}function initColors(){function addTile(low,high){
for(var colorLow,colorHigh,color,offset=low<<16|high<<8,i=0;8>i;i++)colorLow=1&low,colorHigh=(1&high)<<1,color=colorHigh|colorLow,result[offset+i]=color,low>>=1,high>>=1}var low,high,result=new Uint8Array(16777216);for(low=0;256>low;low++)for(high=0;256>high;high++)addTile(low,high);return result}function initReversedTiles(){var low,high,tile,reversed,result=new Uint16Array(65536);for(low=0;256>low;low++)for(high=0;256>high;high++)tile=low<<8|high,reversed=reverseByte(low)<<8|reverseByte(high),result[tile]=reversed;return result}function initReversedBytes(){function calcReverse(original){var i,reverse=0;for(i=7;i>=0;i--)reverse|=(1&original)<<i,original>>>=1;return reverse}var i,result=new Uint8Array(256);for(i=0;256>i;i++)result[i]=calcReverse(i);return result}var colors=initColors(),reversedBytes=initReversedBytes(),reversedTiles=initReversedTiles();exports.getColors=function(tile){var offset=tile<<8;return colors.subarray(offset,offset+8)},exports.reverseByte=reverseByte,exports.reverseTile=function(tile){return reversedTiles[tile]}},{}],35:[function(require){function togglePlaying(el){toggleClassName(el,"nes-paused",el.nesnes.paused),toggleClassName(el,"nes-playing",!el.nesnes.paused)}function toggleClassName(el,className,flag){var classList=el.shadowRoot.querySelector(".nes-wrapper").classList;flag?classList.add(className):classList.remove(className)}function initShadowRoot(el){var template=currentDoc.querySelector("template"),root=el.createShadowRoot();root.appendChild(document.importNode(template.content,!0)),"undefined"!=typeof WebComponents&&WebComponents.ShadowCSS&&WebComponents.ShadowCSS.shimStyling(root,"x-nes"),initEvents(el),toggleClassName(el,"nes-no-fullscreen",!fullscreen.request),toggleClassName(el,"nes-no-audio","undefined"==typeof AudioContext),el.nesnes=new NesNes(root.querySelector("canvas"))}function initAttributes(el){var value;for(var attr in attributes)value=el.getAttribute(attr),"string"==typeof value&&el.attributeChangedCallback(attr,null,value)}function initEvents(el){function getEventListener(callback){return function(e){callback.call(el,e)}}var split,eventName,selector,target,root=el.shadowRoot;for(var key in events)split=key.split(" "),eventName=split[0],selector=split[1],target=selector?root.querySelector(selector):el,target.addEventListener(eventName,getEventListener(events[key]));fullscreen.event&&(document.addEventListener(fullscreen.event,function(){toggleClassName(el,"nes-fullscreen",isFullscreen(el)),scaleCanvas(el)}),window.addEventListener("resize",function(){scaleCanvas(el)}))}function isFullscreen(el){return document[fullscreen.element]===unwrap(el)}function unwrap(el){return"undefined"!=typeof ShadowDOMPolyfill?ShadowDOMPolyfill.unwrap(el):el}function initMouseTimeout(el){var mouseTimeout;el.addEventListener("mousemove",function(){clearTimeout(mouseTimeout),mouseTimeout=setTimeout(function(){toggleClassName(el,"nes-mouse-inactive",!0)},1500),toggleClassName(el,"nes-mouse-inactive",!1)})}function scaleCanvas(el){var canvas=el.shadowRoot.querySelector("canvas"),dx=(canvas.style,window.innerWidth/canvas.offsetWidth),dy=window.innerHeight/canvas.offsetHeight,scale=Math.min(dx,dy),value="scale("+scale+")";isFullscreen(el)?transform(canvas,value):transform(canvas,null)}function transform(el,value){var style=el.style;style.transform=value,style.webkitTransform=value,style.oTransform=value,style.msTransform=value}function addAttributeProperties(properties,attributes){function addProperty(attr){var desc=attributes[attr],prop={get:function(){var result=this.getAttribute(attr);return"boolean"===desc.type&&(result="string"==typeof result),result},set:function(value){if("boolean"===desc.type){if(!value)return void this.removeAttribute(attr);value=""}this.setAttribute(attr,String(value))}};properties[attr]=prop}for(var attr in attributes)addProperty(attr)}function initFullscreen(){var el=document.createElement("div");return el.requestFullScreen?{request:"requestFullScreen",exit:"exitFullScreen",event:"fullscreenchange",element:"fullscreenElement"}:el.webkitRequestFullScreen?{request:"webkitRequestFullScreen",exit:"webkitExitFullscreen",event:"webkitfullscreenchange",element:"webkitFullscreenElement"}:el.mozRequestFullScreen?{request:"mozRequestFullScreen",exit:"mozCancelFullScreen",event:"mozfullscreenchange",element:"mozFullScreenElement"}:el.msRequestFullScreen?{request:"msRequestFullScreen",exit:"msExitFullscreen",event:"msfullscreenchange",element:"msFullscreenElement"}:{}}var currentDoc,NesNes=require("nesnes"),fullscreen=initFullscreen();document.currentScript&&(currentDoc=document.currentScript.ownerDocument),document._currentScript&&(currentDoc=document._currentScript.ownerDocument);var attributes={autoplay:{type:"boolean"},muted:{type:"boolean",change:function(){this.nesnes.output.audio.setEnabled(!this.muted),toggleClassName(this,"nes-muted",this.muted)}},preload:{},poster:{change:function(){if(!this.nesnes.running){var img=this.shadowRoot.querySelector(".nes-poster");img.src=this.getAttribute("poster")}}},src:{change:function(){this.played&&this.load(!0)}}},properties={paused:{get:function(){return this.nesnes.paused},set:function(){}},played:{get:function(){return!!this.nesnes.cartridge},set:function(){}},volume:{get:function(){return this.nesnes.output.audio.volume},set:function(value){this.nesnes.output.audio.setVolume(value)}}};addAttributeProperties(properties,attributes);var events={"click canvas":function(){!this.played||this.paused?this.play():this.pause()},"click .nes-poster":function(){this.play()},"click .nes-play":function(){this.play()},"click .nes-pause":function(){this.pause()},"click .nes-audio-enable":function(){this.muted=!1},"click .nes-audio-disable":function(){this.muted=!0},"input .nes-volume":function(e){var target=e.currentTarget;this.nesnes.output.audio.setVolume(parseInt(target.value,10)/10)},"click .nes-fullscreen-enter":function(){this[fullscreen.request]()},"click .nes-fullscreen-exit":function(){document[fullscreen.exit]()}},nesPrototype=Object.create(HTMLElement.prototype,properties);nesPrototype.createdCallback=function(){initShadowRoot(this),initAttributes(this),initMouseTimeout(this),toggleClassName(this,"nes-inactive",!0),this.autoplay?this.play():"auto"===this.preload&&this.load()},nesPrototype.attributeChangedCallback=function(name){attributes[name]&&attributes[name].change&&attributes[name].change.call(this)},nesPrototype.play=function(){this.played?(toggleClassName(this,"nes-inactive",!1),this.nesnes.play(),togglePlaying(this)):this.load(!0)},nesPrototype.pause=function(){this.nesnes.pause(),togglePlaying(this)},nesPrototype.load=function(play){var self=this;toggleClassName(this,"nes-loading",!0),this.nesnes.load(this.getAttribute("src"),function(){play&&self.play(),toggleClassName(self,"nes-loading",!1)})},document.registerElement("x-nes",{prototype:nesPrototype})},{nesnes:3}]},{},[35]);